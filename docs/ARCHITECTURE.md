# 架构设计文档

## 系统概述

PFinal Asyncio Heartbeat 是一个基于 PFinal Asyncio 和 Workerman 的百万级并发心跳总线系统。它采用 TCP Multiplexing + Channel 调度架构，能够高效处理大规模节点的心跳管理和消息传递。

## 核心架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Client Layer                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ Client 1    │  │ Client 2    │  │ Client N    │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
└─────────┼─────────────────┼─────────────────┼───────────────┘
          │                 │                 │
          └─────────────────┴─────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                   Transport Layer (TCP)                     │
│                   Binary Protocol                           │
└─────────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                    Server Layer                             │
│  ┌────────────────────────────────────────────────────┐     │
│  │         HeartbeatServer (Workerman)                │     │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐         │     │
│  │  │ Worker 1 │  │ Worker 2 │  │ Worker N │         │     │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘         │     │
│  └───────┼─────────────┼─────────────┼────────────────┘     │
└──────────┼─────────────┼─────────────┼──────────────────────┘
           │             │             │
┌──────────┼─────────────┼─────────────┼──────────────────────┐
│          │      Connection Pool      │                      │
│  ┌───────┴─────────────┴─────────────┴──────────┐           │
│  │         TCP Multiplexing Server              │           │
│  └──────────────────┬───────────────────────────┘           │
│                     │                                        │
│  ┌──────────────────┴───────────────────────────┐           │
│  │         Channel Scheduler                    │           │
│  │  ┌────────┐  ┌────────┐  ┌────────┐         │           │
│  │  │ Chan 1 │  │ Chan 2 │  │ Chan N │         │           │
│  │  └────────┘  └────────┘  └────────┘         │           │
│  └──────────────────┬───────────────────────────┘           │
│                     │                                        │
│  ┌──────────────────┴───────────────────────────┐           │
│  │         Node Manager                         │           │
│  │  ┌──────┐  ┌──────┐  ┌──────┐                │           │
│  │  │Node 1│  │Node 2│  │Node N│                │           │
│  │  └──────┘  └──────┘  └──────┘                │           │
│  └──────────────────────────────────────────────┘           │
│                                                              │
│  ┌──────────────────────────────────────────────┐           │
│  │         Heartbeat Monitor                    │           │
│  └──────────────────────────────────────────────┘           │
└──────────────────────────────────────────────────────────────┘
                            │
┌──────────────────────────────────────────────────────────────┐
│                   Monitoring Layer                          │
│  ┌─────────┐  ┌─────────┐  ┌──────────┐                    │
│  │ Logger  │  │ Metrics │  │ Reporter │                    │
│  └─────────┘  └─────────┘  └──────────┘                    │
└──────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. Protocol Layer (协议层)

**Message**: 二进制消息协议
- Magic Number: 0xAB12 (2 bytes)
- Type: 消息类型 (1 byte)
- Length: 负载长度 (4 bytes)
- Payload: JSON 编码的数据 (N bytes)

**消息类型**:
- `HEARTBEAT_REQ (0x01)`: 心跳请求
- `HEARTBEAT_RES (0x02)`: 心跳响应
- `DATA (0x03)`: 数据消息
- `PING (0x04)`: Ping
- `PONG (0x05)`: Pong
- `REGISTER (0x06)`: 节点注册
- `UNREGISTER (0x07)`: 节点注销
- `ERROR (0x08)`: 错误消息

### 2. Channel System (通道系统)

**Channel**: 单个通道实现
- 发送队列 (Send Queue)
- 接收队列 (Recv Queue)
- 异步 Future 支持
- 队列大小限制

**ChannelScheduler**: 通道调度器
- 全局通道管理
- 节点-通道映射
- 通道创建/关闭
- 统计信息收集

**MessageRouter**: 消息路由器
- 通道路由
- 广播消息
- 模式匹配
- 处理器注册

### 3. Node Management (节点管理)

**Node**: 节点模型
- 节点 ID
- 连接信息
- 心跳状态
- 元数据

**NodeManager**: 节点管理器
- 节点注册/注销
- 心跳更新
- 超时检测
- 状态查询

**HeartbeatMonitor**: 心跳监控器
- 定时检查
- 超时回调
- 自动清理

### 4. Server (服务端)

**HeartbeatServer**: 主服务器
- Workerman 集成
- 多进程支持
- 事件处理
- 统计报告

**ConnectionPool**: 连接池
- 连接管理
- 连接限制
- 统计信息

**TcpMultiplexServer**: TCP 多路复用
- 通道管理
- 消息分发

### 5. Client (客户端)

**HeartbeatClient**: 心跳客户端
- 自动连接
- 自动心跳
- 自动重连
- 事件回调

**TcpMultiplexClient**: 客户端多路复用
- 通道管理
- 消息收发

## 数据流

### 连接建立流程

```
Client                    Server
  │                         │
  ├─────TCP Connect────────>│
  │                         │
  │<────Connection OK───────┤
  │                         │
  ├──REGISTER (node_id)────>│
  │                         │ (Create Node)
  │                         │ (Create Channel)
  │                         │
  │<──REGISTER (channel)────┤
  │                         │
  └─────Connected───────────┘
```

### 心跳流程

```
Client                    Server
  │                         │
  ├───HEARTBEAT_REQ────────>│
  │                         │ (Update Heartbeat)
  │<──HEARTBEAT_RES─────────┤
  │                         │
  │    (10s interval)       │
  │                         │
  ├───HEARTBEAT_REQ────────>│
  │                         │
  │<──HEARTBEAT_RES─────────┤
  │                         │
```

### 数据传输流程

```
Client                    Server
  │                         │
  ├──DATA (channel_id)─────>│
  │                         │ (Route to Channel)
  │                         │ (Process Message)
  │<──DATA (response)───────┤
  │                         │
```

## 性能优化

### 1. 事件循环

- 优先使用 Ev 扩展（性能 10倍）
- 其次使用 Event 扩展（性能 4倍）
- 最后使用 Select（基准性能）

### 2. 多进程

- 充分利用多核 CPU
- Worker 进程数 = CPU 核心数
- Reuse Port 支持

### 3. 内存优化

- 对象池
- 连接复用
- 定期清理

### 4. 网络优化

- 二进制协议
- 批量发送
- TCP_NODELAY

## 扩展性

### 水平扩展

```
                    ┌─── Server 1 (100K)
                    │
Load Balancer ──────┼─── Server 2 (100K)
(Nginx/LVS)         │
                    └─── Server N (100K)
```

### 垂直扩展

- 增加 Worker 进程数
- 升级硬件配置
- 优化系统参数

## 可靠性

### 1. 故障检测

- 心跳超时检测
- 连接断开检测
- 健康检查

### 2. 自动恢复

- 客户端自动重连
- 服务端自动清理
- 状态自动同步

### 3. 监控告警

- Prometheus 指标
- 日志记录
- 实时统计

## 安全性

### 1. 连接限制

- 最大连接数
- 单 IP 连接数
- 黑白名单

### 2. 速率限制

- 消息频率限制
- 心跳频率限制

### 3. 协议验证

- Magic Number 验证
- 消息长度验证
- 数据格式验证

## 部署架构

### 单机部署

```
┌─────────────────────────┐
│   Heartbeat Server      │
│   (8 Workers)           │
│   Port: 9501            │
└─────────────────────────┘
```

### 多机部署

```
                    ┌──────────────────┐
                    │  Nginx (TCP LB)  │
                    │  Port: 9500      │
                    └────────┬─────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
┌───────▼────────┐  ┌────────▼────────┐  ┌───────▼────────┐
│  Server 1      │  │  Server 2       │  │  Server N      │
│  192.168.1.101 │  │  192.168.1.102  │  │  192.168.1.10N │
│  Port: 9501    │  │  Port: 9501     │  │  Port: 9501    │
└────────────────┘  └─────────────────┘  └────────────────┘
```

## 监控指标

### 核心指标

- `heartbeat_nodes_total`: 总节点数
- `heartbeat_nodes_online`: 在线节点数
- `heartbeat_connections_active`: 活跃连接数
- `heartbeat_channels_active`: 活跃通道数
- `heartbeat_messages_total`: 消息总数
- `heartbeat_latency_seconds`: 消息延迟

### 性能指标

- CPU 使用率
- 内存使用量
- 网络吞吐量
- 消息处理速度

## 最佳实践

### 1. 配置调优

```php
$config = [
    'worker_count' => 8,           // = CPU 核心数
    'heartbeat_timeout' => 60,     // 生产环境建议 60s
    'heartbeat_check_interval' => 20,
    'max_connections' => 1000000,
];
```

### 2. 系统调优

```bash
# 增加文件描述符
ulimit -n 1000000

# TCP 调优
sysctl -w net.ipv4.tcp_tw_reuse=1
sysctl -w net.ipv4.tcp_fin_timeout=30
sysctl -w net.core.somaxconn=65535
```

### 3. 监控告警

- 在线节点数 < 阈值
- 连接数 > 阈值
- 内存使用 > 阈值
- 消息延迟 > 阈值

---

**文档版本**: 1.0  
**更新时间**: 2025-01-27

