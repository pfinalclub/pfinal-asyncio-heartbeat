# Nginx TCP 负载均衡配置（需要 stream 模块）

stream {
    upstream heartbeat_backend {
        least_conn; # 最少连接数负载均衡
        
        # 后端服务器列表
        server 127.0.0.1:9501 max_fails=3 fail_timeout=30s;
        server 127.0.0.1:9502 max_fails=3 fail_timeout=30s;
        server 127.0.0.1:9503 max_fails=3 fail_timeout=30s;
        server 127.0.0.1:9504 max_fails=3 fail_timeout=30s;
    }
    
    server {
        listen 9500;
        proxy_pass heartbeat_backend;
        proxy_timeout 300s;
        proxy_connect_timeout 5s;
        
        # TCP 缓冲区
        proxy_buffer_size 16k;
    }
    
    # 监控指标端口（HTTP）
    server {
        listen 9510;
        return 404;
    }
}

# HTTP 配置（用于 Web 管理界面或 API）
http {
    upstream heartbeat_metrics {
        server 127.0.0.1:9502;
    }
    
    server {
        listen 8080;
        server_name heartbeat.example.com;
        
        # 监控指标
        location /metrics {
            proxy_pass http://heartbeat_metrics;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # 健康检查
        location /health {
            access_log off;
            return 200 "OK";
        }
        
        # 状态页面
        location /stats {
            proxy_pass http://heartbeat_metrics/stats;
        }
    }
    
    # 日志配置
    access_log /var/log/nginx/heartbeat_access.log;
    error_log /var/log/nginx/heartbeat_error.log;
}

